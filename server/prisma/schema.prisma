generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

enum WorkspaceRole {
    ADMIN
    MEMBER
}

enum TaskStatus {
    TODO
    IN_PROGRESS
    REVIEW
    DONE
}

enum TaskType {
    TASK
    BUG
    FEATURE
    IMPROVEMENT
    OTHER
}

enum ProjectStatus {
    ACTIVE
    PLANNING
    COMPLETED
    ON_HOLD
    CANCELLED
}

enum Priority {
    LOW
    MEDIUM
    HIGH
    CRITICAL
}

enum RequirementStatus {
    DRAFT
    REVIEW
    APPROVED
    IMPLEMENTED
    VERIFIED
    CLOSED
}

enum PlanType {
    FREE
    STARTER
    PROFESSIONAL
}

enum SubscriptionStatus {
    ACTIVE
    CANCELLED
    EXPIRED
    TRIALING
}

model PricingPlan {
    id                String         @id @default(uuid())
    name              String         @unique
    type              PlanType       @unique
    price             Float          @default(0)
    currency          String         @default("USD")
    interval          String?        // "month" or "year"
    description       String?
    features          Json           @default("[]")
    stripeProductId   String?        @unique
    stripePriceId     String?        @unique
    isActive          Boolean        @default(true)
    createdAt         DateTime       @default(now())
    updatedAt         DateTime       @updatedAt

    // Plan limits
    maxProjects       Int            @default(1)
    maxWorkspaces     Int            @default(1)
    maxTeamMembers    Int            @default(3)

    subscriptions     Subscription[]
}

model Subscription {
    id                      String              @id @default(uuid())
    userId                  String
    planId                  String
    stripeSubscriptionId    String?             @unique
    stripeCustomerId        String?
    status                  SubscriptionStatus  @default(ACTIVE)
    startDate               DateTime            @default(now())
    endDate                 DateTime?
    cancelledAt             DateTime?
    createdAt               DateTime            @default(now())
    updatedAt               DateTime            @updatedAt

    user                    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
    plan                    PricingPlan         @relation(fields: [planId], references: [id])

    @@index([userId])
    @@index([stripeSubscriptionId])
}

model Workspace {
    id          String   @id
    name        String
    slug        String   @unique
    description String?
    settings    Json     @default("{}")
    ownerId     String
    createdAt   DateTime @default(now())
    image_url   String   @default("")
    updatedAt   DateTime @updatedAt

    members  WorkspaceMember[]
    projects Project[]
    owner    User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model WorkspaceMember {
    id          String        @id @default(uuid())
    userId      String
    workspaceId String
    message     String        @default("")
    role        WorkspaceRole @default(MEMBER)
    user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@unique([userId, workspaceId]) // prevent duplicate membership
}

model Project {
    id          String          @id @default(uuid())
    name        String
    description String?
    priority    Priority        @default(MEDIUM)
    status      ProjectStatus   @default(ACTIVE)
    start_date  DateTime?
    end_date    DateTime?
    team_lead   String
    workspaceId String
    progress    Int             @default(0)
    archived    Boolean         @default(false)
    archivedAt  DateTime?
    createdAt   DateTime        @default(now())
    updatedAt   DateTime        @updatedAt
    members     ProjectMember[]

    owner     User      @relation("ProjectOwner", fields: [team_lead], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    tasks        Task[]
    requirements Requirement[]
    stakeholders Stakeholder[]
    meetings     Meeting[]
    rfcs         RFC[]
}

model ProjectMember {
    id        String  @id @default(uuid())
    userId    String
    projectId String
    user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@unique([userId, projectId]) // prevent duplicate membership
}

model Task {
    id             String      @id @default(uuid())
    projectId      String
    title          String
    description    String?
    status         TaskStatus  @default(TODO)
    type           TaskType    @default(TASK)
    priority       Priority    @default(MEDIUM)
    assigneeId     String?
    due_date       DateTime
    start_date     DateTime?
    sprint         String?
    tags           Json        @default("[]")
    estimatedHours Int?
    actualHours    Int         @default(0)
    progress       Int         @default(0)
    position       Int         @default(0) // For drag and drop ordering
    createdAt      DateTime    @default(now())
    updatedAt      DateTime    @updatedAt

    project      Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
    assignee     User?             @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: Cascade)
    comments     Comment[]
    requirements RequirementTask[]
    subtasks     Subtask[]
    attachments  TaskAttachment[]
    dependencies TaskDependency[]  @relation("DependentTask")
    dependents   TaskDependency[]  @relation("DependsOnTask")
}

model Comment {
    id        String   @id @default(uuid())
    content   String
    userId    String
    taskId    String
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

// Stakeholder model
model Stakeholder {
    id                      String                   @id @default(uuid())
    projectId               String
    name                    String
    email                   String?
    role                    String
    organization            String?
    department              String?
    phone                   String?
    notes                   String?
    
    // Influence/Interest Matrix
    influence               String                   @default("medium") // low, medium, high
    interest                String                   @default("medium") // low, medium, high
    power                   String                   @default("medium") // low, medium, high
    impact                  String                   @default("medium") // low, medium, high
    
    // Categorization
    category                String                   @default("external") // internal, external, customer, supplier, regulatory
    
    // Engagement Strategy
    engagementApproach      String?                  // manage closely, keep satisfied, keep informed, monitor
    communicationPlan       String?                  // weekly, bi-weekly, monthly, quarterly, as-needed
    communicationChannel    String?                  // email, meetings, reports, calls, etc.
    engagementFrequency     String?                  // high, medium, low
    engagementNotes         String?                  // detailed engagement strategy
    
    // Additional Details
    location                String?
    timezone                String?
    language                String                   @default("en")
    tags                    Json                     @default("[]")
    
    createdAt               DateTime                 @default(now())
    updatedAt               DateTime                 @updatedAt

    project                 Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    requirements            StakeholderRequirement[]
    meetings                MeetingParticipant[]
    history                 StakeholderHistory[]
    attachments            StakeholderAttachment[]
}

// Stakeholder History model
model StakeholderHistory {
    id              String       @id @default(uuid())
    stakeholderId   String
    type            String       // interaction, meeting, concern, update, status_change, etc.
    title           String
    description     String?
    status          String       @default("completed") // scheduled, completed, cancelled
    date            DateTime     @default(now())
    userId          String?      // user who logged this entry
    metadata        Json         @default("{}")
    
    stakeholder     Stakeholder  @relation(fields: [stakeholderId], references: [id], onDelete: Cascade)
}

// Stakeholder Attachments model
model StakeholderAttachment {
    id              String       @id @default(uuid())
    stakeholderId   String
    fileName        String
    fileUrl         String
    fileSize        Int?
    mimeType        String?
    uploadedAt      DateTime     @default(now())
    
    stakeholder     Stakeholder  @relation(fields: [stakeholderId], references: [id], onDelete: Cascade)
}

// Meeting model
model Meeting {
    id          String               @id @default(uuid())
    projectId   String
    title       String
    description String?
    meetingDate DateTime
    duration    Int?                 // in minutes
    location    String?
    notes       String?
    concerns    String?              // stakeholder concerns discussed
    decisions   String?              // decisions made
    actionItems Json                 @default("[]") // action items from meeting
    createdAt   DateTime             @default(now())
    updatedAt   DateTime             @updatedAt

    project      Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
    participants MeetingParticipant[]
    requirements MeetingRequirement[]
}

// Meeting participants
model MeetingParticipant {
    id            String      @id @default(uuid())
    meetingId     String
    stakeholderId String
    attended      Boolean     @default(false)

    meeting     Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
    stakeholder Stakeholder @relation(fields: [stakeholderId], references: [id], onDelete: Cascade)

    @@unique([meetingId, stakeholderId])
}

// Requirement model
model Requirement {
    id                String            @id @default(uuid())
    projectId         String
    requirementId     String            @unique // Custom ID like REQ-001
    title             String
    description       String?
    acceptanceCriteria Json             @default("[]") // Array of criteria
    source            String?           // Source of requirement (customer, internal, regulatory, etc.)
    type              String            @default("FUNCTIONAL") // FUNCTIONAL, NON_FUNCTIONAL, BUSINESS, TECHNICAL
    status            RequirementStatus @default(DRAFT)
    priority          Priority          @default(MEDIUM)
    ownerId           String
    
    // Hierarchical structure
    parentId          String?
    epic              String?           // Epic or feature it belongs to
    
    // Versioning & Baseline
    version           Int               @default(1)
    baselineVersion   Int?              // Current baseline version
    isBaseline        Boolean           @default(false)
    baselineDate      DateTime?
    
    // Additional metadata
    estimatedEffort   Int?              // in hours
    actualEffort      Int?              // in hours
    tags              Json              @default("[]")
    
    createdAt         DateTime          @default(now())
    updatedAt         DateTime          @updatedAt

    project         Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    owner           User                     @relation("RequirementOwner", fields: [ownerId], references: [id])
    parent          Requirement?             @relation("RequirementHierarchy", fields: [parentId], references: [id])
    children        Requirement[]            @relation("RequirementHierarchy")
    stakeholders    StakeholderRequirement[]
    attachments     RequirementAttachment[]
    comments        RequirementComment[]
    history         RequirementHistory[]
    taskLinks       RequirementTask[]
    meetingLinks    MeetingRequirement[]
    rfcs            RFC[]
    testCases       RequirementTestCase[]
}

// Stakeholder-Requirement relationship
model StakeholderRequirement {
    id            String      @id @default(uuid())
    stakeholderId String
    requirementId String
    userId        String?     // If stakeholder is also a user
    role          String      @default("REVIEWER") // OWNER, REVIEWER, APPROVER, INFORMED
    createdAt     DateTime    @default(now())

    stakeholder Stakeholder @relation(fields: [stakeholderId], references: [id], onDelete: Cascade)
    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

    @@unique([stakeholderId, requirementId])
}

// Requirement attachments
model RequirementAttachment {
    id            String      @id @default(uuid())
    requirementId String
    fileName      String
    fileUrl       String      // SharePoint URL
    fileSize      Int?
    mimeType      String?
    uploadedAt    DateTime    @default(now())

    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
}

// Requirement comments
model RequirementComment {
    id            String      @id @default(uuid())
    requirementId String
    userId        String
    content       String
    createdAt     DateTime    @default(now())

    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Requirement history/change log
model RequirementHistory {
    id            String   @id @default(uuid())
    requirementId String
    userId        String
    action        String   // CREATED, UPDATED, STATUS_CHANGED, PRIORITY_CHANGED, etc.
    changes       Json     @default("{}")
    version       Int
    createdAt     DateTime @default(now())

    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    user        User        @relation(fields: [userId], references: [id])
}

// Requirement-Task traceability
model RequirementTask {
    id            String      @id @default(uuid())
    requirementId String
    taskId        String

    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    task        Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

    @@unique([requirementId, taskId])
}

// Meeting-Requirement relationship
model MeetingRequirement {
    id            String      @id @default(uuid())
    meetingId     String
    requirementId String
    discussed     Boolean     @default(false)

    meeting     Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)

    @@unique([meetingId, requirementId])
}

// Subtask model
model Subtask {
    id        String   @id @default(uuid())
    taskId    String
    title     String
    completed Boolean  @default(false)
    position  Int      @default(0)
    createdAt DateTime @default(now())

    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

// Task Attachment model
model TaskAttachment {
    id         String   @id @default(uuid())
    taskId     String
    fileName   String
    fileUrl    String
    fileSize   Int?
    mimeType   String?
    uploadedAt DateTime @default(now())

    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

// Task Dependencies
model TaskDependency {
    id              String   @id @default(uuid())
    dependentTaskId String
    dependsOnTaskId String
    createdAt       DateTime @default(now())

    dependentTask Task @relation("DependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)
    dependsOnTask Task @relation("DependsOnTask", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

    @@unique([dependentTaskId, dependsOnTaskId])
}

// RFC (Request for Change) Status
enum RFCStatus {
    PROPOSED
    UNDER_REVIEW
    APPROVED
    REJECTED
    IMPLEMENTED
    CANCELLED
}

// RFC Impact Level
enum ImpactLevel {
    LOW
    MEDIUM
    HIGH
    CRITICAL
}

// RFC - Request for Change model
model RFC {
    id                String         @id @default(uuid())
    rfcId             String         @unique // Custom ID like RFC-001
    projectId         String
    requirementId     String
    title             String
    description       String?
    reason            String         // Reason for change
    impact            String?        // Impact description
    impactLevel       ImpactLevel    @default(MEDIUM)
    risk              String?        // Risk assessment
    costEstimate      Float?         // Estimated cost
    scheduleImpact    String?        // Schedule impact description
    status            RFCStatus      @default(PROPOSED)
    requesterId       String
    reviewerId        String?
    approvedBy        String?
    approvedAt        DateTime?
    rejectionReason   String?
    implementedAt     DateTime?
    
    // Impact analysis
    affectedTasks     Json           @default("[]") // Array of task IDs
    affectedReleases  Json           @default("[]") // Array of release information
    timeEstimate      Int?           // Estimated time in hours
    
    createdAt         DateTime       @default(now())
    updatedAt         DateTime       @updatedAt

    project           Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
    requirement       Requirement    @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    requester         User           @relation("RFCRequester", fields: [requesterId], references: [id])
    reviewer          User?          @relation("RFCReviewer", fields: [reviewerId], references: [id])
    approver          User?          @relation("RFCApprover", fields: [approvedBy], references: [id])
    comments          RFCComment[]
    attachments       RFCAttachment[]
    history           RFCHistory[]
}

// RFC Comments
model RFCComment {
    id        String   @id @default(uuid())
    rfcId     String
    userId    String
    content   String
    createdAt DateTime @default(now())

    rfc  RFC  @relation(fields: [rfcId], references: [id], onDelete: Cascade)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// RFC Attachments
model RFCAttachment {
    id         String   @id @default(uuid())
    rfcId      String
    fileName   String
    fileUrl    String
    fileSize   Int?
    mimeType   String?
    uploadedAt DateTime @default(now())

    rfc RFC @relation(fields: [rfcId], references: [id], onDelete: Cascade)
}

// RFC History
model RFCHistory {
    id        String   @id @default(uuid())
    rfcId     String
    userId    String
    action    String   // CREATED, STATUS_CHANGED, APPROVED, REJECTED, etc.
    changes   Json     @default("{}")
    createdAt DateTime @default(now())

    rfc  RFC  @relation(fields: [rfcId], references: [id], onDelete: Cascade)
    user User @relation(fields: [userId], references: [id])
}

// Requirement Test Cases (for traceability)
model RequirementTestCase {
    id            String      @id @default(uuid())
    requirementId String
    testCaseId    String      // External test case ID
    testCaseName  String
    status        String      @default("PENDING") // PENDING, PASSED, FAILED
    lastTestedAt  DateTime?
    
    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    
    @@unique([requirementId, testCaseId])
}

// User model with all relations
model User {
    id        String   @id
    name      String
    email     String   @unique
    image     String   @default("")
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    workspaces           WorkspaceMember[]
    projects             Project[]               @relation("ProjectOwner")
    tasks                Task[]                  @relation("TaskAssignee")
    comments             Comment[]
    ownedWorkspaces      Workspace[]
    ProjectMember        ProjectMember[]
    subscriptions        Subscription[]
    ownedRequirements    Requirement[]           @relation("RequirementOwner")
    stakeholderRelations StakeholderRequirement[]
    requirementComments  RequirementComment[]
    requirementHistory   RequirementHistory[]
    requestedRFCs        RFC[]                   @relation("RFCRequester")
    reviewedRFCs         RFC[]                   @relation("RFCReviewer")
    approvedRFCs         RFC[]                   @relation("RFCApprover")
    rfcComments          RFCComment[]
    rfcHistory           RFCHistory[]
}
